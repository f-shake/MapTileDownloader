<UserControl
    x:Class="MapTileDownloader.UI.Views.DownloadPanel"
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:c="clr-namespace:FzLib.Avalonia.Controls;assembly=FzLib.Avalonia"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:m="clr-namespace:MapTileDownloader.Models;assembly=MapTileDownloader"
    xmlns:map="using:MapTileDownloader.UI.Mapping"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:mtd="using:MapTileDownloader"
    xmlns:sys="clr-namespace:System;assembly=System.Runtime"
    xmlns:v="clr-namespace:MapTileDownloader.UI.Views"
    xmlns:vm="clr-namespace:MapTileDownloader.UI.ViewModels"
    d:DesignHeight="600"
    d:DesignWidth="300"
    x:DataType="vm:DownloadViewModel"
    mc:Ignorable="d">
    <Grid RowDefinitions="Auto,16,*,16,Auto,16,Auto">
        <HeaderedContentControl
            x:Name="grp1"
            Classes="GroupBox"
            Header="下载范围"
            IsEnabled="{Binding !IsDownloading}">
            <StackPanel
                Orientation="Vertical"
                Spacing="8">
                <Grid ColumnDefinitions="*,8,*">
                    <Button
                        Command="{Binding SelectOnMapCommand}"
                        Content="在地图中选择" />
                    <Button
                        Grid.Column="2"
                        Command="{Binding SelectOnMapCancelCommand}"
                        Content="取消"
                        IsVisible="{Binding IsSelecting}" />
                    <Button
                        Grid.Column="2"
                        Command="{Binding ClearCommand}"
                        Content="清除已选范围"
                        IsEnabled="{Binding Coordinates, Converter={StaticResource NotNullConverter}}"
                        IsVisible="{Binding !IsSelecting}" />
                </Grid>
                <TextBlock
                    HorizontalAlignment="Center"
                    Text="{Binding SelectionMessage}" />
                <Grid ColumnDefinitions="*,8,*">
                    <Button
                        Command="{Binding ImportCoordinatesCommand}"
                        Content="导入" />
                    <Button
                        Grid.Column="2"
                        Command="{Binding ExportCoordinatesCommand}"
                        Content="导出"
                        IsEnabled="{Binding Coordinates, Converter={StaticResource NotNullConverter}}" />
                </Grid>
            </StackPanel>
        </HeaderedContentControl>

        <!--  由于TextBox的不知什么原因，下面这个GroupBox的宽度有问题，所以强制绑定到上面  -->
        <HeaderedContentControl
            Grid.Row="2"
            Width="{Binding #grp1.Bounds.Width}"
            Classes="GroupBox"
            Header="下载选项"
            IsEnabled="{Binding !IsDownloading}">
            <ScrollViewer Padding="0,0,8,0">
                <StackPanel
                    Orientation="Vertical"
                    Spacing="8">
                    <c:FormItem Header="{Binding MinLevel, StringFormat={}最小级别 ({0})}">
                        <Slider
                            x:Name="sldMin"
                            IsSnapToTickEnabled="True"
                            Maximum="{Binding MaxLevel}"
                            Minimum="0"
                            TickFrequency="1"
                            TickPlacement="BottomRight"
                            ToolTip.Tip="{Binding MinLevel}"
                            Value="{Binding MinLevel}" />
                    </c:FormItem>
                    <c:FormItem Header="{Binding MaxLevel, StringFormat={}最大级别 ({0})}">
                        <Slider
                            x:Name="sldMax"
                            IsSnapToTickEnabled="True"
                            Maximum="20"
                            Minimum="{Binding MinLevel}"
                            TickFrequency="1"
                            TickPlacement="BottomRight"
                            ToolTip.Tip="{Binding MaxLevel}"
                            Value="{Binding MaxLevel}" />
                    </c:FormItem>
                    <c:FormItem Header="保存至">
                        <v:MbtilesPicker />
                    </c:FormItem>
                    <c:FormItem Header="{Binding MaxConcurrency, StringFormat={}最大并行数量 ({0})}">
                        <Slider
                            IsSnapToTickEnabled="True"
                            Maximum="20"
                            Minimum="1"
                            TickFrequency="1"
                            TickPlacement="BottomRight"
                            ToolTip.Tip="{Binding MaxConcurrency}"
                            Value="{Binding MaxConcurrency}" />
                    </c:FormItem>
                </StackPanel>
            </ScrollViewer>
        </HeaderedContentControl>

        <HeaderedContentControl
            Grid.Row="4"
            Classes="GroupBox"
            Header="下载进度">
            <StackPanel
                Orientation="Vertical"
                Spacing="8">
                <ListBox
                    MaxHeight="200"
                    ItemsSource="{Binding Levels}"
                    SelectedItem="{Binding SelectedLevel}">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Grid ColumnDefinitions="Auto,16,*">
                                <TextBlock>
                                    <Run Text="{Binding Level, StringFormat={}第{0}级}" />
                                    <Run Text="{Binding DownloadedCount}" />
                                    <Run Text="/" />
                                    <Run Text="{Binding Count}" />
                                </TextBlock>

                                <ProgressBar
                                    Grid.Column="2"
                                    MinWidth="0"
                                    Foreground="{Binding $parent[UserControl].Foreground}"
                                    Maximum="{Binding Count}"
                                    Minimum="0"
                                    Value="{Binding DownloadedCount}" />
                            </Grid>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
                <ProgressBar
                    Maximum="{Binding TotalCount}"
                    Value="{Binding DownloadedCount}" />

                <TextBlock HorizontalAlignment="Center">
                    <Run Text="共" />
                    <Run Text="{Binding TotalCount}" />
                    <Run Text="个瓦片，已处理" />
                    <Run Text="{Binding DownloadedCount}" />
                    <Run Text="个" />
                </TextBlock>
                <Grid ColumnDefinitions="*,8,*,8,*">
                    <TextBlock Text="{Binding SkipCount, StringFormat={}跳过：{0}}" />
                    <TextBlock
                        Grid.Column="2"
                        Text="{Binding SuccessCount, StringFormat={}成功：{0}}" />

                    <Button
                        Grid.Column="4"
                        Margin="-4"
                        Padding="3,4"
                        HorizontalAlignment="Left"
                        Background="Transparent">
                        <TextBlock Text="{Binding FailedCount, StringFormat={}失败：{0}}" />
                        <Button.Flyout>
                            <Flyout>
                                <DataGrid
                                    Width="400"
                                    Height="300"
                                    IsReadOnly="True"
                                    ItemsSource="{Binding ErrorTiles}">
                                    <DataGrid.RowDetailsTemplate>
                                        <DataTemplate DataType="mtd:DownloadStatusChangedEventArgs">
                                            <SelectableTextBlock
                                                Margin="8"
                                                Text="{Binding Detail}"
                                                TextWrapping="Wrap" />
                                        </DataTemplate>
                                    </DataGrid.RowDetailsTemplate>
                                    <DataGrid.Columns>
                                        <DataGridTextColumn
                                            Binding="{Binding Tile.TileIndex.Level}"
                                            Header="Z" />
                                        <DataGridTextColumn
                                            Binding="{Binding Tile.TileIndex.Col}"
                                            Header="X" />
                                        <DataGridTextColumn
                                            Binding="{Binding Tile.TileIndex.Row}"
                                            Header="Y" />
                                        <DataGridTextColumn
                                            Binding="{Binding Message}"
                                            Header="信息" />
                                    </DataGrid.Columns>
                                </DataGrid>
                            </Flyout>
                        </Button.Flyout>
                    </Button>
                </Grid>
            </StackPanel>
        </HeaderedContentControl>
        <UniformGrid
            Grid.Row="6"
            ColumnSpacing="8"
            Columns="3"
            IsEnabled="{Binding Coordinates, Converter={StaticResource NotNullConverter}}">
            <Button
                Command="{Binding InitializeCommand}"
                Content="初始化" />
            <Button
                Command="{Binding DownloadTilesCommand}"
                Content="开始下载"
                IsEnabled="{Binding CanDownload}" />
            <Button
                Command="{Binding DownloadTilesCancelCommand}"
                Content="停止" />
        </UniformGrid>

    </Grid>
</UserControl>
